<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="å…­çˆ»é æ¸¬">
<meta name="theme-color" content="#1a1008">
<title>å…­çˆ»é«”è‚²é æ¸¬ç³»çµ±</title>
<link rel="manifest" href="./manifest.json">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=ZCOOL+XiaoWei&display=swap');
  :root{--ink:#1a1008;--rice:#f5f0e8;--red:#c0392b;--gold:#b8860b;--faded:#8b7355;--paper:#ede8dc;--brush:#2c1a0e;--blue:#2471a3;}
  *{box-sizing:border-box;margin:0;padding:0;}
  body{background:var(--rice);color:var(--ink);font-family:'Noto Serif TC','Source Han Serif TC','æ€æºå®‹é«”',serif;min-height:100vh;}
  h1{font-family:'ZCOOL XiaoWei','Noto Serif TC',serif;text-align:center;font-size:1.9rem;letter-spacing:.3em;color:var(--brush);padding:1.2rem;border-bottom:2px solid var(--gold);background:linear-gradient(180deg,#fff8f0 0%,var(--rice) 100%);}
  .tabs{display:flex;background:var(--paper);border-bottom:2px solid var(--gold);}
  .tab{flex:1;padding:.8rem;text-align:center;cursor:pointer;font-size:.95rem;color:var(--faded);border:none;background:transparent;font-family:inherit;transition:all .2s;}
  .tab.active{color:var(--red);background:var(--rice);border-bottom:3px solid var(--red);font-weight:700;}
  .panel{display:none;padding:1.2rem;max-width:860px;margin:0 auto;}
  .panel.active{display:block;}
  .st{font-family:'ZCOOL XiaoWei','Noto Serif TC',serif;font-size:1rem;color:var(--gold);border-left:4px solid var(--gold);padding-left:.6rem;margin:1rem 0 .6rem;letter-spacing:.15em;}
  .row{display:flex;gap:.8rem;flex-wrap:wrap;}
  .field{flex:1;min-width:130px;}
  label{display:block;font-size:.8rem;color:var(--faded);margin-bottom:.25rem;}
  input,select{width:100%;padding:.5rem .6rem;border:1px solid #c8b89a;background:#fffdf8;font-family:inherit;font-size:.9rem;color:var(--ink);border-radius:3px;outline:none;}
  input:focus,select:focus{border-color:var(--gold);}
  .yg{display:grid;grid-template-columns:repeat(6,1fr);gap:.5rem;margin:.5rem 0 .8rem;}
  .yi{display:flex;flex-direction:column;align-items:center;gap:.3rem;background:#fffdf8;border:1px solid #ddd5c0;border-radius:4px;padding:.5rem .2rem;}
  .ynum{font-size:.72rem;color:var(--faded);}
  .ybig{font-size:1.1rem;font-weight:700;height:1.6rem;display:flex;align-items:center;}
  .c-y{color:#b8860b;}.c-i{color:#555;}.c-ly{color:#c0392b;}.c-li{color:#2471a3;}
  .ysel{width:100%;font-size:.75rem;padding:.25rem;background:#fff;border:1px solid #c8b89a;}
  .gc{background:#fffdf8;border:1px solid #c8b89a;border-radius:6px;padding:1.2rem;margin-top:.8rem;}
  .gnr{display:flex;align-items:center;gap:1rem;margin-bottom:.8rem;padding-bottom:.6rem;border-bottom:1px solid #e0d5c0;flex-wrap:wrap;}
  .gmn{font-family:'ZCOOL XiaoWei','Noto Serif TC',serif;font-size:1.4rem;color:var(--brush);}
  .gbn{font-family:'ZCOOL XiaoWei','Noto Serif TC',serif;font-size:1.1rem;color:var(--red);}
  .gsub{font-size:.82rem;color:var(--faded);}
  .lt{width:100%;border-collapse:collapse;font-size:.85rem;}
  .lt th{background:var(--brush);color:#f5e6c8;padding:.35rem .4rem;text-align:center;font-size:.78rem;}
  .lt td{padding:.35rem .4rem;text-align:center;border-bottom:1px solid #e8dfc8;}
  .lt tr.divr td{border-top:2px solid var(--ink);}
  .lt tr.sr td{background:rgba(192,57,43,.06);}
  .lt tr.yr td{background:rgba(36,113,163,.06);}
  .dy{color:#b8860b;font-weight:700;}.di{color:#555;}.dd{color:#c0392b;font-weight:700;}
  .ts{background:var(--red);color:#fff;font-size:.72rem;padding:0 5px;border-radius:2px;}
  .ty{background:var(--blue);color:#fff;font-size:.72rem;padding:0 5px;border-radius:2px;}
  .tdg{color:var(--red);font-size:.72rem;}
  .lb{display:inline-block;background:rgba(184,134,11,.12);border:1px solid var(--gold);border-radius:3px;padding:.25rem .7rem;font-size:.85rem;color:var(--gold);margin-top:.4rem;}
  .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem 1.2rem;border:none;cursor:pointer;font-family:inherit;font-size:.9rem;border-radius:3px;transition:all .2s;}
  .bp{background:var(--brush);color:#f5e6c8;}.bp:hover{background:#4a2c10;}
  .bg{background:var(--gold);color:#fff;}.bg:hover{background:#9a7209;}
  .bv{background:#27ae60;color:#fff;}.bv:hover{background:#1e8449;}
  .brow{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:1rem;}
  .sr2{display:flex;gap:.8rem;flex-wrap:wrap;margin-bottom:1rem;}
  .sc{flex:1;min-width:100px;background:#fffdf8;border:1px solid #c8b89a;border-radius:4px;padding:.8rem;text-align:center;}
  .sc .num{font-size:1.6rem;font-family:'ZCOOL XiaoWei','Noto Serif TC',serif;color:var(--brush);}
  .sc .lbl{font-size:.75rem;color:var(--faded);margin-top:.2rem;}
  .ht{width:100%;border-collapse:collapse;font-size:.82rem;}
  .ht th{background:var(--brush);color:#f5e6c8;padding:.4rem;text-align:center;}
  .ht td{padding:.4rem;text-align:center;border-bottom:1px solid #e0d5c0;}
  .ok{color:#27ae60;font-weight:700;}.ng{color:var(--red);font-weight:700;}
  .es{text-align:center;color:var(--faded);padding:2.5rem 1rem;}
  .io-bar{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem;padding:.8rem;background:#fffdf8;border:1px solid #e0d5c0;border-radius:6px;align-items:center;}
  .io-bar span{font-size:.82rem;color:var(--faded);margin-right:.3rem;}
  .toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:#1a1008;color:#f5e6c8;padding:.6rem 1.4rem;border-radius:20px;font-size:.88rem;z-index:999;pointer-events:none;opacity:0;transition:opacity .3s;}
  .toast.show{opacity:1;}
  @media(max-width:600px){.yg{grid-template-columns:repeat(3,1fr);}h1{font-size:1.3rem;}.io-bar{flex-direction:column;align-items:stretch;}}
</style>
</head>
<body>
<h1>â˜° å…­çˆ»é«”è‚²é æ¸¬ç³»çµ± â˜·</h1>
<div class="tabs">
  <button class="tab active" onclick="sw('input')">ğŸ“ èµ·å¦è¼¸å…¥</button>
  <button class="tab" onclick="sw('result')">â˜° å¦è±¡å±•ç¤º</button>
  <button class="tab" onclick="sw('history')">ğŸ“œ æ­·å²è¨˜éŒ„</button>
</div>

<!-- â”€â”€ èµ·å¦è¼¸å…¥ â”€â”€ -->
<div id="tab-input" class="panel active">
  <div class="st">æ¯”è³½è³‡è¨Š</div>
  <div class="row">
    <div class="field"><label>ä¸–æ–¹ï¼ˆä¸»éšŠï¼‰</label><input type="text" id="shi-t" placeholder="ä¾‹ï¼šç«è…¿é¬¥å£«"/></div>
    <div class="field"><label>æ‡‰æ–¹ï¼ˆå®¢éšŠï¼‰</label><input type="text" id="ying-t" placeholder="ä¾‹ï¼šæ±æ´‹é¯‰é­š"/></div>
  </div>
  <div class="row" style="margin-top:.6rem">
    <div class="field"><label>æ¯”è³½æ—¥æœŸ</label><input type="date" id="m-date"/></div>
    <div class="field"><label>æ¯”è³½æ™‚é–“</label><input type="time" id="m-time"/></div>
  </div>
  <div id="lb" class="lb" style="display:none"></div>
  <div class="st" style="margin-top:1rem">æ“²å¦ï¼ˆåˆçˆ»â†’å…­çˆ»ï¼Œç”±å·¦è‡³å³ï¼‰</div>
  <p style="font-size:.78rem;color:var(--faded);margin-bottom:.5rem">è€é™½â—‹ï¼ä¸‰éŠ…æ¿å…¨æ­£ï¼ˆå‹•ï¼‰ï¼›è€é™°Ã—ï¼ä¸‰éŠ…æ¿å…¨åï¼ˆå‹•ï¼‰</p>
  <div class="yg" id="yao-inputs"></div>

  <div id="gua-card" style="display:none" class="gc">
    <div class="gnr">
      <div><div style="font-size:.75rem;color:var(--faded)">æœ¬å¦</div><div class="gmn" id="ben-n">â€”</div></div>
      <div id="arr" style="display:none;font-size:1.2rem;color:var(--gold)">â†’</div>
      <div id="bian-b" style="display:none"><div style="font-size:.75rem;color:var(--faded)">ä¹‹å¦</div><div class="gbn" id="bian-n">â€”</div></div>
      <div style="margin-left:auto">
        <div class="gsub" id="tri-i">â€”</div>
        <div class="gsub" id="gong-i">â€”</div>
      </div>
    </div>
    <table class="lt">
      <thead><tr><th>çˆ»ä½</th><th>å…­ç¥</th><th>å…­è¦ª</th><th>åœ°æ”¯</th><th>çˆ»è±¡</th><th>è®Šçˆ»</th><th>ä¼ç¥</th><th>æ¨™è¨˜</th></tr></thead>
      <tbody id="lt-b"></tbody>
    </table>
    <div style="margin-top:.5rem;font-size:.78rem;color:var(--faded)" id="notes"></div>
  </div>

  <div class="brow">
    <button class="btn bp" onclick="calcGua()">âš¡ æ’å¦</button>
    <button class="btn bg" onclick="copyPrompt()">ğŸ“‹ è¤‡è£½è©¢å•æ–‡æ¡ˆ</button>
    <button class="btn" style="background:#e0d5c0" onclick="clrF()">âœ• æ¸…ç©º</button>
  </div>
  <div id="copy-box" style="display:none;margin-top:.8rem;background:#fffdf8;border:1px solid #c8b89a;border-radius:6px;padding:1rem">
    <div style="font-size:.78rem;color:#8b7355;margin-bottom:.4rem">ğŸ“‹ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œå¯ç›´æ¥è²¼å…¥ Claude / ChatGPT ç­‰ AI è©¢å•ï¼š</div>
    <pre id="copy-txt" style="font-family:inherit;font-size:.82rem;line-height:1.8;white-space:pre-wrap;color:#2c1a0e;background:#f5f0e8;padding:.8rem;border-radius:4px;border:1px solid #e0d5c0;"></pre>
    <div style="margin-top:.6rem;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
      <select id="pw" style="font-family:inherit;font-size:.85rem;padding:.35rem .5rem;border:1px solid #c8b89a;background:#fffdf8;color:#2c1a0e;border-radius:3px">
        <option value="">â€” é¸æ“‡é æ¸¬çµè«– â€”</option>
        <option value="ä¸–å‹">ä¸–æ–¹å‹</option>
        <option value="æ‡‰å‹">æ‡‰æ–¹å‹</option>
        <option value="å¹³å±€">å¹³å±€</option>
      </select>
      <button class="btn bp" style="padding:.35rem .8rem;font-size:.82rem" onclick="saveP()">ğŸ’¾ ä¿å­˜é æ¸¬</button>
    </div>
  </div>
</div>

<!-- â”€â”€ å¦è±¡å±•ç¤º â”€â”€ -->
<div id="tab-result" class="panel">
  <div id="res-area"><div class="es">è«‹å…ˆåœ¨ã€Œèµ·å¦è¼¸å…¥ã€ç”Ÿæˆå¦è±¡</div></div>
</div>

<!-- â”€â”€ æ­·å²è¨˜éŒ„ â”€â”€ -->
<div id="tab-history" class="panel">
  <div class="io-bar">
    <span>è³‡æ–™ç®¡ç†ï¼š</span>
    <button class="btn bv" style="padding:.4rem .9rem;font-size:.82rem" onclick="exportHist()">â¬‡ åŒ¯å‡ºè¨˜éŒ„</button>
    <button class="btn bg" style="padding:.4rem .9rem;font-size:.82rem" onclick="document.getElementById('imp-f').click()">â¬† åŒ¯å…¥è¨˜éŒ„</button>
    <input type="file" id="imp-f" accept=".json" style="display:none" onchange="importHist(event)">
    <button class="btn" style="padding:.4rem .9rem;font-size:.82rem;background:#e74c3c;color:#fff" onclick="clearAllHist()">ğŸ—‘ æ¸…é™¤å…¨éƒ¨</button>
  </div>
  <div class="sr2">
    <div class="sc"><div class="num" id="s-t">0</div><div class="lbl">ç¸½å ´æ•¸</div></div>
    <div class="sc"><div class="num" id="s-ok">0</div><div class="lbl">é æ¸¬æ­£ç¢º</div></div>
    <div class="sc"><div class="num" id="s-r">â€”</div><div class="lbl">æº–ç¢ºç‡</div></div>
    <div class="sc"><div class="num" id="s-p">0</div><div class="lbl">å¾…ç¢ºèª</div></div>
  </div>
  <div id="hist-l"><div class="es">å°šç„¡è¨˜éŒ„</div></div>
</div>

<!-- Toast æç¤º -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â• è¾²æ›† â•â•â•â•â•â•
const LD=[0x04AE53,0x0A5748,0x5526BD,0x0D2650,0x0D9544,0x46AAB9,0x056A4D,0x9AD257,0x02B545,0x3A9151,0x076531,0x96D45B,0x0B6A4F,0x1B4541,0x072A54,0x0F2552,0x092B60,0x5C5B57,0x0D1545,0x3A9453,0x0E5249,0x06AA44,0x56AB50,0x0AD645,0x436553,0x082B48,0x0B6A57,0x0CA64B,0x25D44F,0x05B645,0x96D4A9,0x06D449,0x14B64D,0x0AB657,0x09AD51,0x28D445,0x0DA4B3,0x0D4A57,0x5D254B,0x0B544F,0x0B6A45,0x396D53,0x096D48,0x1AEB55,0x04AE49,0x0A5749,0x55265D,0x0D2651,0x0E9545,0x36AAB9,0x056A4D,0xB6A4D3,0x0DA544,0x35AAB8,0x056A4D,0x9AD254,0x04AE48,0x7A56BD,0x0A5748,0x102650,0x0F2644,0x0EA658];
const TGN=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
const DBN=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
const CMN=['æ­£','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹','å','å†¬','è‡˜'];
const CDN=['åˆä¸€','åˆäºŒ','åˆä¸‰','åˆå››','åˆäº”','åˆå…­','åˆä¸ƒ','åˆå…«','åˆä¹','åˆå','åä¸€','åäºŒ','åä¸‰','åå››','åäº”','åå…­','åä¸ƒ','åå…«','åä¹','äºŒå','å»¿ä¸€','å»¿äºŒ','å»¿ä¸‰','å»¿å››','å»¿äº”','å»¿å…­','å»¿ä¸ƒ','å»¿å…«','å»¿ä¹','ä¸‰å'];
function lyD(y){let s=348,i;const x=y-1900;for(i=0x8000;i>0x8;i>>=1)s+=(LD[x]&i)?1:0;return s+lyLD(y);}
function lyLD(y){const x=y-1900;return(LD[x]&0xf)?((LD[x]&0x10000)?30:29):0;}
function lyLM(y){return LD[y-1900]&0xf;}
function lyMD(y,m){return(LD[y-1900]&(0x10000>>m))?30:29;}
function s2l(yr,mo,da){
  const date=new Date(yr,mo-1,da),base=new Date(1900,0,31);
  let off=Math.round((date-base)/86400000),i,temp=0,ly=1900;
  for(i=1900;i<2100&&off>0;i++){temp=lyD(i);off-=temp;ly=i+1;}
  if(off<0){off+=temp;ly=i-1;}
  let lm=1,ld=1,isLeap=false;
  const lmth=lyLM(ly),ldays=lmth?lyLD(ly):0;
  for(i=1;i<13&&off>0;i++){
    if(lmth>0&&i===lmth+1&&!isLeap){--i;isLeap=true;temp=ldays;}
    else temp=lyMD(ly,i);
    if(isLeap&&i===lmth+1)isLeap=false;
    off-=temp;lm=i;
  }
  if(off===0&&lmth>0&&i===lmth+1){if(isLeap)isLeap=false;else{isLeap=true;--i;}}
  if(off<0){off+=temp;lm=i-1;}
  ld=off+1;
  const si=((ly-4)%10+10)%10,bi=((ly-4)%12+12)%12;
  const b2=new Date(1900,0,31);
  const td=Math.round((new Date(yr,mo-1,da)-b2)/86400000);
  const dti=((0+td)%10+10)%10;
  const ddi=((4+td)%12+12)%12; // åŸºæº–1900/1/31=ç”²è¾°ï¼Œåœ°æ”¯è¾°=4
  // æœˆå¹²æ”¯ï¼ˆä¾ç¯€æ°£ï¼‰
  const JIEQI_DAY=[6,4,6,5,6,6,7,7,8,8,7,7];
  const jDay=JIEQI_DAY[mo-1];
  const solarMonth=(da>=jDay)?mo:mo-1;
  const adjMonth=((solarMonth-2+12)%12);
  const yti=((yr-4)%10+10)%10;
  const mTianBase=(yti*2+2)%10;
  const mTian=TGN[(mTianBase+adjMonth)%10];
  const mDi=DBN[(2+adjMonth)%12];
  return{year:ly,month:lm,day:ld,isLeap,yearGZ:TGN[si]+DBN[bi],
    monthStr:(isLeap?'é–':'')+CMN[lm-1]+'æœˆ',dayStr:CDN[ld-1],
    dayTian:TGN[dti],dayDi:DBN[ddi],
    dayGZ:TGN[dti]+DBN[ddi],monthGZ:mTian+mDi};
}

// â•â•â•â•â•â• å…«å¦ â•â•â•â•â•â•
const TRI={'ä¹¾':[1,1,1],'å…Œ':[1,1,0],'é›¢':[1,0,1],'éœ‡':[1,0,0],'å·½':[0,1,1],'å':[0,1,0],'è‰®':[0,0,1],'å¤':[0,0,0]};
function ft(a,b,c){for(const[n,y]of Object.entries(TRI)){if(y[0]===a&&y[1]===b&&y[2]===c)return n;}return null;}
function toBase(v){return(v==='yang'||v==='laoyang')?1:0;}
function toDong(v){return v==='laoyang'?0:v==='laoyin'?1:toBase(v);}

// â•â•â•â•â•â• ç´ç”² â•â•â•â•â•â•
const DZ=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
const NAJIA={'ä¹¾':{inner:'å­',outer:'åˆ',dir:2},'å':{inner:'å¯…',outer:'ç”³',dir:2},'è‰®':{inner:'è¾°',outer:'æˆŒ',dir:2},'éœ‡':{inner:'å­',outer:'åˆ',dir:2},'å·½':{inner:'ä¸‘',outer:'æœª',dir:-2},'é›¢':{inner:'å¯',outer:'é…‰',dir:-2},'å¤':{inner:'æœª',outer:'ä¸‘',dir:-2},'å…Œ':{inner:'å·³',outer:'äº¥',dir:-2}};
function dzStep(start,n,dir){const i=DZ.indexOf(start);return DZ[((i+dir*n)%12+12)%12];}
function getTriDZ(tri,isOuter){const{inner,outer,dir}=NAJIA[tri];const s=isOuter?outer:inner;return[0,1,2].map(n=>dzStep(s,n,dir));}

// â•â•â•â•â•â• äº”è¡Œå…­è¦ª â•â•â•â•â•â•
const WX={'é‡‘':0,'æ°´':1,'æœ¨':2,'ç«':3,'åœŸ':4};
const DZ_WX={'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«','åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´'};
const GONG_WX={'ä¹¾':'é‡‘','å':'æ°´','è‰®':'åœŸ','éœ‡':'æœ¨','å·½':'æœ¨','é›¢':'ç«','å¤':'åœŸ','å…Œ':'é‡‘'};
function liuqin2(gWx,dz){
  const g=WX[gWx],d=WX[DZ_WX[dz]];
  if(g===d)return'å…„å¼Ÿ';
  if((g+1)%5===d)return'å­å­«';
  if((d+1)%5===g)return'çˆ¶æ¯';
  if((g+2)%5===d)return'å¦»è²¡';
  if((d+2)%5===g)return'å®˜é¬¼';
  return'å…„å¼Ÿ';
}

// â•â•â•â•â•â• å…­åå››å¦ â•â•â•â•â•â•
const HEX64={
  // â•â• ä¹¾å®®ï¼ˆé‡‘ï¼‰â•â•
  'ä¹¾ä¹¾':{g:'ä¹¾',s:6,y:3,n:'ä¹¾ç‚ºå¤©'},
  'ä¹¾å·½':{g:'ä¹¾',s:1,y:4,n:'å¤©é¢¨å§¤'},
  'ä¹¾è‰®':{g:'ä¹¾',s:2,y:5,n:'å¤©å±±é¯'},
  'ä¹¾å¤':{g:'ä¹¾',s:3,y:6,n:'å¤©åœ°å¦'},
  'å·½å¤':{g:'ä¹¾',s:4,y:1,n:'é¢¨åœ°è§€'},
  'è‰®å¤':{g:'ä¹¾',s:5,y:2,n:'å±±åœ°å‰'},
  'é›¢å¤':{g:'ä¹¾',s:4,y:1,n:'ç«åœ°æ™‰'},
  'é›¢ä¹¾':{g:'ä¹¾',s:3,y:6,n:'ç«å¤©å¤§æœ‰'},
  // â•â• åå®®ï¼ˆæ°´ï¼‰â•â•
  'åå':{g:'å',s:6,y:3,n:'åç‚ºæ°´'},
  'åå…Œ':{g:'å',s:1,y:4,n:'æ°´æ¾¤ç¯€'},
  'åéœ‡':{g:'å',s:2,y:5,n:'æ°´é›·å±¯'},
  'åé›¢':{g:'å',s:3,y:6,n:'æ°´ç«æ—¢æ¿Ÿ'},
  'å…Œé›¢':{g:'å',s:4,y:1,n:'æ¾¤ç«é©'},
  'éœ‡é›¢':{g:'å',s:5,y:2,n:'é›·ç«è±'},
  'å¤é›¢':{g:'å',s:4,y:1,n:'åœ°ç«æ˜å¤·'},
  'å¤å':{g:'å',s:3,y:6,n:'åœ°æ°´å¸«'},
  // â•â• è‰®å®®ï¼ˆåœŸï¼‰â•â•
  'è‰®è‰®':{g:'è‰®',s:6,y:3,n:'è‰®ç‚ºå±±'},
  'è‰®é›¢':{g:'è‰®',s:1,y:4,n:'å±±ç«è³'},
  'è‰®ä¹¾':{g:'è‰®',s:2,y:5,n:'å±±å¤©å¤§ç•œ'},
  'è‰®å…Œ':{g:'è‰®',s:3,y:6,n:'å±±æ¾¤æ'},
  'é›¢å…Œ':{g:'è‰®',s:4,y:1,n:'ç«æ¾¤ç½'},
  'ä¹¾å…Œ':{g:'è‰®',s:5,y:2,n:'å¤©æ¾¤å±¥'},
  'å·½å…Œ':{g:'è‰®',s:4,y:1,n:'é¢¨æ¾¤ä¸­å­š'},
  'å·½è‰®':{g:'è‰®',s:3,y:6,n:'é¢¨å±±æ¼¸'},
  // â•â• éœ‡å®®ï¼ˆæœ¨ï¼‰â•â•
  'éœ‡éœ‡':{g:'éœ‡',s:6,y:3,n:'éœ‡ç‚ºé›·'},
  'éœ‡å¤':{g:'éœ‡',s:1,y:4,n:'é›·åœ°è±«'},
  'éœ‡å':{g:'éœ‡',s:2,y:5,n:'é›·æ°´è§£'},
  'éœ‡å·½':{g:'éœ‡',s:3,y:6,n:'é›·é¢¨æ’'},
  'å¤å·½':{g:'éœ‡',s:4,y:1,n:'åœ°é¢¨å‡'},
  'åå·½':{g:'éœ‡',s:5,y:2,n:'æ°´é¢¨äº•'},
  'å…Œå·½':{g:'éœ‡',s:4,y:1,n:'æ¾¤é¢¨å¤§é'},
  'å…Œéœ‡':{g:'éœ‡',s:3,y:6,n:'æ¾¤é›·éš¨'},
  // â•â• å·½å®®ï¼ˆæœ¨ï¼‰â•â•
  'å·½å·½':{g:'å·½',s:6,y:3,n:'å·½ç‚ºé¢¨'},
  'å·½ä¹¾':{g:'å·½',s:1,y:4,n:'é¢¨å¤©å°ç•œ'},
  'å·½é›¢':{g:'å·½',s:2,y:5,n:'é¢¨ç«å®¶äºº'},
  'å·½éœ‡':{g:'å·½',s:3,y:6,n:'é¢¨é›·ç›Š'},
  'ä¹¾éœ‡':{g:'å·½',s:4,y:1,n:'å¤©é›·ç„¡å¦„'},
  'é›¢éœ‡':{g:'å·½',s:5,y:2,n:'ç«é›·å™¬å—‘'},
  'è‰®éœ‡':{g:'å·½',s:4,y:1,n:'å±±é›·é ¤'},
  'è‰®å·½':{g:'å·½',s:3,y:6,n:'å±±é¢¨è ±'},
  // â•â• é›¢å®®ï¼ˆç«ï¼‰â•â•
  'é›¢é›¢':{g:'é›¢',s:6,y:3,n:'é›¢ç‚ºç«'},
  'é›¢è‰®':{g:'é›¢',s:1,y:4,n:'ç«å±±æ—…'},
  'é›¢å·½':{g:'é›¢',s:2,y:5,n:'ç«é¢¨é¼'},
  'é›¢å':{g:'é›¢',s:3,y:6,n:'ç«æ°´æœªæ¿Ÿ'},
  'è‰®å':{g:'é›¢',s:4,y:1,n:'å±±æ°´è’™'},
  'å·½å':{g:'é›¢',s:5,y:2,n:'é¢¨æ°´æ¸™'},
  'ä¹¾å':{g:'é›¢',s:4,y:1,n:'å¤©æ°´è¨Ÿ'},
  'ä¹¾é›¢':{g:'é›¢',s:3,y:6,n:'å¤©ç«åŒäºº'},
  // â•â• å¤å®®ï¼ˆåœŸï¼‰â•â•
  'å¤å¤':{g:'å¤',s:6,y:3,n:'å¤ç‚ºåœ°'},
  'å¤éœ‡':{g:'å¤',s:1,y:4,n:'åœ°é›·å¾©'},
  'å¤å…Œ':{g:'å¤',s:2,y:5,n:'åœ°æ¾¤è‡¨'},
  'å¤ä¹¾':{g:'å¤',s:3,y:6,n:'åœ°å¤©æ³°'},
  'éœ‡ä¹¾':{g:'å¤',s:4,y:1,n:'é›·å¤©å¤§å£¯'},
  'å…Œä¹¾':{g:'å¤',s:5,y:2,n:'æ¾¤å¤©å¤¬'},
  'åä¹¾':{g:'å¤',s:4,y:1,n:'æ°´å¤©éœ€'},
  'åå¤':{g:'å¤',s:3,y:6,n:'æ°´åœ°æ¯”'},
  // â•â• å…Œå®®ï¼ˆé‡‘ï¼‰â•â•
  'å…Œå…Œ':{g:'å…Œ',s:6,y:3,n:'å…Œç‚ºæ¾¤'},
  'å…Œå':{g:'å…Œ',s:1,y:4,n:'æ¾¤æ°´å›°'},
  'å…Œå¤':{g:'å…Œ',s:2,y:5,n:'æ¾¤åœ°èƒ'},
  'å…Œè‰®':{g:'å…Œ',s:3,y:6,n:'æ¾¤å±±å’¸'},
  'åè‰®':{g:'å…Œ',s:4,y:1,n:'æ°´å±±è¹‡'},
  'å¤è‰®':{g:'å…Œ',s:5,y:2,n:'åœ°å±±è¬™'},
  'éœ‡è‰®':{g:'å…Œ',s:4,y:1,n:'é›·å±±å°é'},
  'éœ‡å…Œ':{g:'å…Œ',s:3,y:6,n:'é›·æ¾¤æ­¸å¦¹'},
};
function findHex(s,x){return HEX64[s+x]||null;}

// â•â•â•â•â•â• å…­ç¥ â•â•â•â•â•â•
// ã€Šåœç­®æ­£å®—ã€‹å…­ç¥èµ·æ³•ï¼šç”²ä¹™é’é¾ã€ä¸™ä¸æœ±é›€ã€æˆŠå‹¾é™³ã€å·±è£è›‡ã€åºšè¾›ç™½è™ã€å£¬ç™¸ç„æ­¦
const LIUSHEN={
  'ç”²':['é’é¾','æœ±é›€','å‹¾é™³','è£è›‡','ç™½è™','ç„æ­¦'],
  'ä¹™':['é’é¾','æœ±é›€','å‹¾é™³','è£è›‡','ç™½è™','ç„æ­¦'],
  'ä¸™':['æœ±é›€','å‹¾é™³','è£è›‡','ç™½è™','ç„æ­¦','é’é¾'],
  'ä¸':['æœ±é›€','å‹¾é™³','è£è›‡','ç™½è™','ç„æ­¦','é’é¾'],
  'æˆŠ':['å‹¾é™³','è£è›‡','ç™½è™','ç„æ­¦','é’é¾','æœ±é›€'],
  'å·±':['è£è›‡','ç™½è™','ç„æ­¦','é’é¾','æœ±é›€','å‹¾é™³'],
  'åºš':['ç™½è™','ç„æ­¦','é’é¾','æœ±é›€','å‹¾é™³','è£è›‡'],
  'è¾›':['ç™½è™','ç„æ­¦','é’é¾','æœ±é›€','å‹¾é™³','è£è›‡'],
  'å£¬':['ç„æ­¦','é’é¾','æœ±é›€','å‹¾é™³','è£è›‡','ç™½è™'],
  'ç™¸':['ç„æ­¦','é’é¾','æœ±é›€','å‹¾é™³','è£è›‡','ç™½è™'],
};

// â•â•â•â•â•â• çˆ»è¼¸å…¥ â•â•â•â•â•â•
const YN=['åˆçˆ»','äºŒçˆ»','ä¸‰çˆ»','å››çˆ»','äº”çˆ»','å…­çˆ»'];
const YO=[{v:'yang',l:'é™½ â€”â€”',s:'â€”â€”',c:'c-y'},{v:'yin',l:'é™° â€” â€”',s:'â€” â€”',c:'c-i'},{v:'laoyang',l:'è€é™½ â—‹',s:'â€”â€”â—‹',c:'c-ly'},{v:'laoyin',l:'è€é™° Ã—',s:'â€” Ã—â€”',c:'c-li'}];

function initY(){
  const c=document.getElementById('yao-inputs');c.innerHTML='';
  for(let i=0;i<6;i++){
    const d=document.createElement('div');d.className='yi';
    d.innerHTML=`<div class="ynum">${YN[i]}</div><div class="ybig c-y" id="ys${i}">â€”â€”</div><select class="ysel" id="y${i}" onchange="updY(${i});autoCalc()">${YO.map(o=>`<option value="${o.v}">${o.l}</option>`).join('')}</select>`;
    c.appendChild(d);
  }
}
function updY(i){
  const o=YO.find(x=>x.v===document.getElementById(`y${i}`).value);
  const el=document.getElementById(`ys${i}`);
  el.textContent=o.s;el.className=`ybig ${o.c}`;
}

let LI=null;
function updLunar(){
  const ds=document.getElementById('m-date').value;if(!ds)return;
  const[y,m,d]=ds.split('-').map(Number);
  try{
    LI=s2l(y,m,d);
    const el=document.getElementById('lb');
    el.style.display='inline-block';
    el.textContent=`è¾²æ›† ${LI.yearGZ}å¹´ ${LI.monthStr} ${LI.dayStr}ã€€${LI.dayGZ}æ—¥ ${LI.monthGZ}æœˆ`;
    if(CG)autoCalc();
  }catch(e){}
}

// â•â•â•â•â•â• ä¸»è¨ˆç®— â•â•â•â•â•â•
let CG=null;
function autoCalc(){
  const yaos=[];for(let i=0;i<6;i++)yaos.push(document.getElementById(`y${i}`).value);
  const xia=ft(toBase(yaos[0]),toBase(yaos[1]),toBase(yaos[2]));
  const shang=ft(toBase(yaos[3]),toBase(yaos[4]),toBase(yaos[5]));
  if(!xia||!shang)return;
  const hex=findHex(shang,xia);
  if(!hex){console.warn('æ‰¾ä¸åˆ°å¦ï¼š',shang,xia);return;}
  const hasDong=yaos.some(v=>v==='laoyang'||v==='laoyin');
  let bHex=null,bx,bs;
  if(hasDong){
    bx=ft(toDong(yaos[0]),toDong(yaos[1]),toDong(yaos[2]));
    bs=ft(toDong(yaos[3]),toDong(yaos[4]),toDong(yaos[5]));
    if(bx&&bs)bHex=findHex(bs,bx)||{n:bs+'ä¸Š'+bx+'ä¸‹',g:bs,_shang:bs,_xia:bx};
  }
  const lowerDZ=getTriDZ(xia,false);
  const upperDZ=getTriDZ(shang,true);
  const allDZ=[...lowerDZ,...upperDZ];
  let bDZ=null;
  if(bHex){
    const bxia=bHex._xia||bx,bshang=bHex._shang||bs;
    bDZ=[...getTriDZ(bxia,false),...getTriDZ(bshang,true)];
  }
  const gWx=GONG_WX[hex.g]||GONG_WX[shang];
  const lqArr=allDZ.map(dz=>liuqin2(gWx,dz));
  const dayT=LI?LI.dayTian:'ç”²';
  const sixG=LIUSHEN[dayT]||LIUSHEN['ç”²'];
  // ç©ºäº¡
  const kongArr=[];
  if(LI){
    const tIdx=TGN.indexOf(LI.dayTian),dIdx=DZ.indexOf(LI.dayDi||'å­');
    const xunStart=((dIdx-tIdx)%12+12)%12;
    kongArr.push(DZ[(xunStart+10)%12],DZ[(xunStart+11)%12]);
  }
  // ä¼ç¥ï¼ˆã€Šåœç­®æ­£å®—ã€‹ï¼šæœ¬å¦ç¼ºæŸå…­è¦ªï¼Œå»æœ¬å®®é¦–å¦æ‰¾ï¼Œå°æ‡‰çˆ»ä½è—ä¼ç¥ï¼‰
  // æ³¨æ„ï¼šéœçˆ»å…­è¦ª + è®Šçˆ»å…­è¦ªéƒ½ç®—ã€Œå·²ä¸Šå¦ã€ï¼Œæœ‰å‹•çˆ»åŒ–å‡ºçš„å…­è¦ªä¸ç«‹ä¼ç¥
  const pureL=getTriDZ(hex.g,false),pureU=getTriDZ(hex.g,true);
  const pureDZ=[...pureL,...pureU];
  const pureLQ=pureDZ.map(dz=>liuqin2(gWx,dz));
  const presentLQ=new Set(lqArr);
  // åªæœ‰ã€Œå‹•çˆ»çš„è®Šçˆ»åœ°æ”¯ã€æ‰ç®—å·²ä¸Šå¦ï¼ˆéæ•´å€‹ä¹‹å¦ï¼‰
  if(bDZ){
    yaos.forEach((y,i)=>{
      if(y==='laoyang'||y==='laoyin') presentLQ.add(liuqin2(gWx,bDZ[i]));
    });
  }
  // æ‰¾æœ¬å¦ç¼ºå¸­çš„å…­è¦ªï¼Œæ¯ç¨®å…­è¦ªåªå–ç´”å¦ä¸­ç¬¬ä¸€å€‹å‡ºç¾çš„çˆ»ä½
  const missingLQ=new Set(['çˆ¶æ¯','å…„å¼Ÿ','å­å­«','å¦»è²¡','å®˜é¬¼'].filter(lq=>!presentLQ.has(lq)));
  const fuShen=new Array(6).fill('');
  const usedPos=new Set();
  for(let i=0;i<6;i++){
    if(missingLQ.has(pureLQ[i])&&!usedPos.has(pureLQ[i])){
      fuShen[i]=`${pureLQ[i]}${pureDZ[i]}`;
      usedPos.add(pureLQ[i]);
    }
  }
  CG={hex,bHex,yaos,sixG,allDZ,bDZ,lqArr,lunarI:LI,shang,xia,kongArr,fuShen};
  renderCard();
}
function calcGua(){autoCalc();if(CG)sw('result');}

function renderCard(){
  if(!CG)return;
  const{hex,bHex,yaos,sixG,allDZ,bDZ,lqArr,kongArr,fuShen}=CG;
  document.getElementById('ben-n').textContent=hex.n;
  document.getElementById('gong-i').textContent=`å®®ï¼š${hex.g}å®®ï¼ˆ${GONG_WX[hex.g]}ï¼‰`;
  document.getElementById('tri-i').textContent=`ï¼ˆ${CG.shang}ä¸Š / ${CG.xia}ä¸‹ï¼‰`;
  const hb=bHex&&bHex.n!==hex.n;
  document.getElementById('arr').style.display=hb?'':'none';
  document.getElementById('bian-b').style.display=hb?'':'none';
  if(hb)document.getElementById('bian-n').textContent=bHex.n;
  const sym={yang:'â”€â”€',yin:'â€“ â€“',laoyang:'â”€â”€â—‹',laoyin:'â€“ Ã—â€“'};
  const cls={yang:'dy',yin:'di',laoyang:'dd',laoyin:'dd'};
  const kSet=new Set(kongArr||[]);
  let tb='';
  for(let i=5;i>=0;i--){
    const v=yaos[i],iD=v==='laoyang'||v==='laoyin';
    const iS=(i+1)===hex.s,iY=(i+1)===hex.y;
    const bz=iD&&bDZ&&bDZ[i]?`${liuqin2(GONG_WX[hex.g],bDZ[i])}${bDZ[i]}`:'';
    const isKong=kSet.has(allDZ[i]);
    const dzLabel=`${allDZ[i]}${isKong?'<sup style="color:#c0392b;font-size:.65rem">ç©º</sup>':''}`;
    const fuTxt=fuShen&&fuShen[i]?`<span style="color:#7b3fa0;font-size:.75rem">${fuShen[i]}</span>`:'';
    tb+=`<tr class="${i===2?'divr':''} ${iS?'sr':iY?'yr':''}">
      <td>${YN[i]}</td><td>${sixG[i]}</td><td>${lqArr[i]}</td>
      <td><strong>${dzLabel}</strong></td>
      <td class="${cls[v]}">${sym[v]}</td>
      <td style="color:#c0392b;font-size:.8rem">${bz}</td>
      <td>${fuTxt}</td>
      <td>${iS?'<span class="ts">ä¸–</span>':''}${iY?'<span class="ty">æ‡‰</span>':''}${iD?'<span class="tdg">å‹•</span>':''}</td>
    </tr>`;
  }
  document.getElementById('lt-b').innerHTML=tb;
  const dongs=yaos.map((v,i)=>(v==='laoyang'||v==='laoyin')?YN[i]:null).filter(Boolean);
  const ns=[];
  if(dongs.length)ns.push('å‹•çˆ»ï¼š'+dongs.join('ã€'));
  ns.push(`ä¸–çˆ»ï¼š${YN[hex.s-1]}ï¼ˆ${lqArr[hex.s-1]} ${allDZ[hex.s-1]}${kSet.has(allDZ[hex.s-1])?'ç©º':''}ï¼‰`);
  ns.push(`æ‡‰çˆ»ï¼š${YN[hex.y-1]}ï¼ˆ${lqArr[hex.y-1]} ${allDZ[hex.y-1]}${kSet.has(allDZ[hex.y-1])?'ç©º':''}ï¼‰`);
  if(kongArr&&kongArr.length)ns.push(`æ—¬ç©ºï¼š${kongArr.join('ã€')}`);
  document.getElementById('notes').textContent=ns.join('ã€€');
  document.getElementById('gua-card').style.display='block';
}

// â•â•â•â•â•â• çµæœé¢æ¿ â•â•â•â•â•â•
function renderResult(){
  if(!CG){document.getElementById('res-area').innerHTML='<div class="es">è«‹å…ˆåœ¨ã€Œèµ·å¦è¼¸å…¥ã€ç”Ÿæˆå¦è±¡</div>';return;}
  const st=document.getElementById('shi-t').value||'ä¸–æ–¹';
  const yt=document.getElementById('ying-t').value||'æ‡‰æ–¹';
  const ds=document.getElementById('m-date').value||'';
  const ts=document.getElementById('m-time').value||'';
  const{hex,bHex,yaos,sixG,allDZ,bDZ,lqArr,lunarI:li,kongArr,fuShen}=CG;
  const dd=ds.replace(/-/g,'')+(ts?' '+ts.replace(':',''):'');
  const ls=li?`è¾²æ›†${li.monthStr}${li.dayStr}`:'';
  const sm={yang:'|',yin:'||',laoyang:'|â—‹',laoyin:'||Ã—'};
  const kSet=new Set(kongArr||[]);
  let lh='';
  for(let i=5;i>=0;i--){
    const v=yaos[i],iD=v==='laoyang'||v==='laoyin';
    const iS=(i+1)===hex.s,iY=(i+1)===hex.y;
    const bz=iD&&bDZ&&bDZ[i]?`${liuqin2(GONG_WX[hex.g],bDZ[i])}${bDZ[i]}`:'';
    const bd=i===2?'border-top:2px solid #1a1008;margin-top:4px':'';
    const isKong=kSet.has(allDZ[i]);
    const dzLabel=allDZ[i]+(isKong?'<sup style="color:#c0392b;font-size:.6rem">ç©º</sup>':'');
    const fuTxt=fuShen&&fuShen[i]?`<span style="color:#7b3fa0;font-size:.72rem;margin-left:2px">(ä¼${fuShen[i]})</span>`:'';
    lh+=`<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px dotted #e0d5c0;${bd};font-size:.88rem">
      <span style="width:24px">${iS?'<b style="color:#c0392b">ä¸–</b>':iY?'<b style="color:#2471a3">æ‡‰</b>':''}</span>
      <span style="width:30px;color:#8b7355;font-size:.8rem">${sixG[i]}</span>
      <span style="width:28px;font-size:.82rem">${lqArr[i]}</span>
      <span style="width:22px;font-weight:700">${dzLabel}</span>
      <span style="width:44px;color:${iD?'#c0392b':'#b8860b'};font-weight:700">${sm[v]}</span>
      <span style="font-size:.75rem;color:#2471a3">${bz}</span>
      ${fuTxt}
      <span style="margin-left:auto;font-size:.75rem;color:#8b7355">${YN[i]}</span>
    </div>`;
  }
  document.getElementById('res-area').innerHTML=`
    <div style="background:#fffdf8;border:1px solid #c8b89a;border-radius:6px;padding:1.2rem">
      <div style="text-align:center;border-bottom:1px solid #e0d5c0;padding-bottom:.6rem;margin-bottom:.8rem">
        <div style="font-size:.82rem;color:#8b7355">æ¯”è³½æ™‚é–“ï¼ˆå°ç£æ™‚é–“ï¼‰ï¼š${dd}ã€€${ls}</div>
        <div style="font-size:.95rem;margin-top:.3rem">ä¸–ã€${st}ã€‘ï¼›æ‡‰ã€${yt}ã€‘</div>
      </div>
      <div style="display:flex;gap:1rem;align-items:flex-start">
        <div style="flex:1">${lh}</div>
        <div style="min-width:110px;text-align:center">
          <div style="font-family:'ZCOOL XiaoWei',serif;font-size:1.3rem;border:1px solid #b8860b;padding:.4rem .6rem;color:#2c1a0e">${hex.n}</div>
          ${bHex&&bHex.n!==hex.n?`<div style="font-size:.75rem;color:#8b7355;margin-top:4px">â†’ä¹‹å¦</div><div style="color:#c0392b;font-family:'ZCOOL XiaoWei',serif;font-size:1.1rem">${bHex.n}</div>`:''}
          <div style="font-size:.78rem;color:#8b7355;margin-top:6px">${li?li.monthStr+'ã€€'+li.dayStr:''}</div>
        </div>
      </div>
    </div>`;
}

// â•â•â•â•â•â• è¤‡è£½è©¢å•æ–‡æ¡ˆ â•â•â•â•â•â•
function copyPrompt(){
  autoCalc();if(!CG){alert('è«‹å…ˆé¸æ“‡å…­çˆ»');return;}
  const st=document.getElementById('shi-t').value.trim();
  const yt=document.getElementById('ying-t').value.trim();
  if(!st||!yt){alert('è«‹å…ˆå¡«å…¥ä¸–æ–¹ï¼ˆä¸»éšŠï¼‰å’Œæ‡‰æ–¹ï¼ˆå®¢éšŠï¼‰çš„éšŠä¼åç¨±');return;}
  const{hex,bHex,yaos,allDZ,lqArr,lunarI:li}=CG;
  const mp={yang:'é™½',yin:'é™°',laoyang:'è€é™½ï¼ˆå‹•ï¼‰',laoyin:'è€é™°ï¼ˆå‹•ï¼‰'};
  const yaoNames=['åˆçˆ»','äºŒçˆ»','ä¸‰çˆ»','å››çˆ»','äº”çˆ»','å…­çˆ»'];
  const{bDZ,fuShen,kongArr}=CG;
  const WX2={'é‡‘':0,'æ°´':1,'æœ¨':2,'ç«':3,'åœŸ':4};
  const DZ_WX2={'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«','åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´'};
  const GONG_WX2={'ä¹¾':'é‡‘','å':'æ°´','è‰®':'åœŸ','éœ‡':'æœ¨','å·½':'æœ¨','é›¢':'ç«','å¤':'åœŸ','å…Œ':'é‡‘'};
  function lq2(gWx,dz){const g=WX2[gWx],d=WX2[DZ_WX2[dz]];if(g===d)return'å…„å¼Ÿ';if((g+1)%5===d)return'å­å­«';if((d+1)%5===g)return'çˆ¶æ¯';if((g+2)%5===d)return'å¦»è²¡';if((d+2)%5===g)return'å®˜é¬¼';return'å…„å¼Ÿ';}
  const gWx2=GONG_WX2[hex.g];
  const yaoLines=yaos.map((v,i)=>{
    let line=`${yaoNames[i]}ï¼š${lqArr[i]} ${allDZ[i]} ${mp[v]}`;
    if((v==='laoyang'||v==='laoyin')&&bDZ&&bDZ[i]){
      line+=` åŒ–${lq2(gWx2,bDZ[i])}${bDZ[i]}`;
    }
    return line;
  }).join('\n');
  const dayGZ=li?li.dayGZ:'â€”';
  const monGZ=li?li.monthGZ:'â€”';
  const bianStr=bHex&&bHex.n!==hex.n?`\nè®Šå¦ç‚ºï¼š${bHex.n}`:'';
  const prompt=`å¹«æˆ‘é æ¸¬ä¸€å ´è³½äº‹\nä¸–ç‚º${st}ï¼Œæ‡‰ç‚º${yt}\n${dayGZ}æ—¥ï¼Œ${monGZ}æœˆ\nä¸»å¦ç‚ºï¼š${hex.n}${bianStr}\n\n${yaoLines}`;
  document.getElementById('copy-txt').textContent=prompt;
  document.getElementById('copy-box').style.display='block';
  navigator.clipboard.writeText(prompt).catch(()=>{});
}

// â•â•â•â•â•â• æœ¬åœ°å„²å­˜ï¼ˆlocalStorageï¼‰â•â•â•â•â•â•
const STORE_KEY='liuyao-hist-v1';
let hist=[];

function svH(){
  try{localStorage.setItem(STORE_KEY,JSON.stringify(hist));}catch(e){console.warn('å„²å­˜å¤±æ•—',e);}
}
function ldH(){
  try{
    const raw=localStorage.getItem(STORE_KEY);
    hist=raw?JSON.parse(raw):[];
  }catch(e){hist=[];}
  rnH();
}

// â”€â”€ åŒ¯å‡º â”€â”€
function exportHist(){
  if(!hist.length){showToast('å°šç„¡è¨˜éŒ„å¯åŒ¯å‡º');return;}
  const data={version:1,exportedAt:new Date().toISOString(),count:hist.length,records:hist};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const ts=new Date().toISOString().slice(0,10).replace(/-/g,'');
  a.href=url;a.download=`å…­çˆ»è¨˜éŒ„_${ts}.json`;
  document.body.appendChild(a);a.click();
  document.body.removeChild(a);URL.revokeObjectURL(url);
  showToast(`âœ… å·²åŒ¯å‡º ${hist.length} ç­†è¨˜éŒ„`);
}

// â”€â”€ åŒ¯å…¥ â”€â”€
function importHist(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      let incoming=[];
      if(Array.isArray(data))incoming=data;
      else if(data.records&&Array.isArray(data.records))incoming=data.records;
      else{showToast('âŒ æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');return;}
      // åˆä½µï¼šä»¥ id å»é‡ï¼Œæ–°è³‡æ–™å„ªå…ˆ
      const existIds=new Set(hist.map(r=>r.id));
      let newCount=0;
      for(const r of incoming){
        if(!existIds.has(r.id)){hist.push(r);newCount++;}
      }
      hist.sort((a,b)=>b.id-a.id);
      svH();rnH();
      showToast(`âœ… åŒ¯å…¥æˆåŠŸï¼Œæ–°å¢ ${newCount} ç­†ï¼ˆå…± ${hist.length} ç­†ï¼‰`);
    }catch(err){showToast('âŒ åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼éŒ¯èª¤');}
    e.target.value='';
  };
  reader.readAsText(file);
}

// â”€â”€ æ¸…é™¤å…¨éƒ¨ â”€â”€
function clearAllHist(){
  if(!confirm(`ç¢ºå®šè¦æ¸…é™¤å…¨éƒ¨ ${hist.length} ç­†è¨˜éŒ„ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`))return;
  hist=[];svH();rnH();
  showToast('å·²æ¸…é™¤æ‰€æœ‰è¨˜éŒ„');
}

// â”€â”€ Toast â”€â”€
let toastTimer=null;
function showToast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  if(toastTimer)clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.classList.remove('show'),2800);
}

function saveP(){
  if(!CG){alert('è«‹å…ˆæ’å¦');return;}
  const pw=document.getElementById('pw').value;
  if(!pw){alert('è«‹é¸æ“‡é æ¸¬çµæœ');return;}
  const r={id:Date.now(),date:document.getElementById('m-date').value,time:document.getElementById('m-time').value,
    st:document.getElementById('shi-t').value||'ä¸–æ–¹',yt:document.getElementById('ying-t').value||'æ‡‰æ–¹',
    hexName:CG.hex.n,bianName:CG.bHex?.n||'',predicted:pw,actual:null,ok:null};
  hist.unshift(r);svH();rnH();
  showToast(`âœ… å·²ä¿å­˜ï¼é æ¸¬ï¼š${pw}`);
}

function rnH(){
  upStats();
  const c=document.getElementById('hist-l');
  if(!hist.length){c.innerHTML='<div class="es">å°šç„¡æ­·å²è¨˜éŒ„</div>';return;}
  let h=`<table class="ht"><thead><tr><th>æ—¥æœŸ</th><th>ä¸–æ–¹</th><th>æ‡‰æ–¹</th><th>æœ¬å¦</th><th>é æ¸¬</th><th>å¯¦éš›</th><th>æº–ç¢º</th><th></th></tr></thead><tbody>`;
  hist.forEach((r,i)=>{
    const ck=r.ok===true?'<span class="ok">âœ“</span>':r.ok===false?'<span class="ng">âœ—</span>':'â€”';
    h+=`<tr><td>${r.date||'â€”'}</td><td>${r.st}</td><td>${r.yt}</td>
      <td style="font-size:.78rem">${r.hexName}${r.bianName&&r.bianName!==r.hexName?'â†’'+r.bianName:''}</td>
      <td>${r.predicted}</td>
      <td>${r.actual?`<strong>${r.actual}</strong>`:`
        <select id="ar${i}" style="font-size:.75rem;padding:.1rem;width:70px"><option value="">â€”</option>
        <option value="ä¸–å‹">ä¸–å‹</option><option value="æ‡‰å‹">æ‡‰å‹</option><option value="å¹³å±€">å¹³å±€</option></select>
        <button onclick="sbR(${i})" style="font-size:.72rem;padding:.1rem .3rem;cursor:pointer;border:1px solid #c8b89a;background:#fffdf8;font-family:inherit">ç¢ºèª</button>`}
      </td><td>${ck}</td>
      <td><button onclick="dlR(${i})" style="font-size:.7rem;padding:.1rem .3rem;cursor:pointer;border:1px solid #e0d5c0;background:#f5f0e8;font-family:inherit">åˆª</button></td></tr>`;
  });
  h+='</tbody></table>';c.innerHTML=h;
}
function sbR(i){const v=document.getElementById(`ar${i}`)?.value;if(!v){alert('è«‹é¸æ“‡');return;}hist[i].actual=v;hist[i].ok=hist[i].predicted===v;svH();rnH();}
function dlR(i){if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))return;hist.splice(i,1);svH();rnH();}
function upStats(){
  const t=hist.length,d=hist.filter(r=>r.actual);
  const ok=d.filter(r=>r.ok).length,p=hist.filter(r=>!r.actual).length;
  document.getElementById('s-t').textContent=t;
  document.getElementById('s-ok').textContent=ok;
  document.getElementById('s-r').textContent=d.length?Math.round(ok/d.length*100)+'%':'â€”';
  document.getElementById('s-p').textContent=p;
}

function sw(n){
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',['input','result','history'][i]===n));
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-'+n).classList.add('active');
  if(n==='result')renderResult();
  if(n==='history')rnH();
}
function clrF(){
  document.getElementById('shi-t').value='';document.getElementById('ying-t').value='';document.getElementById('m-time').value='';
  for(let i=0;i<6;i++){document.getElementById(`y${i}`).value='yang';updY(i);}
  document.getElementById('gua-card').style.display='none';
  document.getElementById('copy-box').style.display='none';
  CG=null;
}

// â•â•â•â•â•â• PWA Service Worker è¨»å†Š â•â•â•â•â•â•
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js')
      .then(()=>console.log('SW registered'))
      .catch(e=>console.warn('SW failed',e));
  });
}

document.addEventListener('DOMContentLoaded',()=>{
  initY();
  document.getElementById('m-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('m-date').addEventListener('change',updLunar);
  updLunar();ldH();
});
</script>
</body>
</html>
